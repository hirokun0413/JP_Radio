{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import libQ from 'kew';\r\nimport VConf from 'v-conf';\r\nimport JpRadio from './lib/radio';\r\n\r\nexport = ControllerJpRadio;\r\n\r\nclass ControllerJpRadio {\r\n  private context: any;\r\n  private commandRouter: any;\r\n  private logger: any;\r\n  private configManager: any;\r\n  private config: any;\r\n  private readonly serviceName = 'jp_radio';\r\n  private appRadio: any;\r\n\r\n  constructor(context: any) {\r\n    this.context = context;\r\n    this.commandRouter = context.coreCommand;\r\n    this.logger = context.logger;\r\n    this.configManager = context.configManager;\r\n  }\r\n\r\n  restartPlugin(): void {\r\n    this.onStop().then(() => {\r\n      this.onStart().catch(() => {\r\n        this.commandRouter.pushToastMessage('error', 'Restart Failed', 'The plugin could not be restarted.');\r\n      });\r\n    });\r\n  }\r\n\r\n  private showRestartModal(): void {\r\n    const message = {\r\n      title: 'Plugin Restart Required',\r\n      message: 'Changes have been made that require the JP Radio plugin to be restarted. Please click the restart button below.',\r\n      size: 'lg',\r\n      buttons: [\r\n        {\r\n          name: this.commandRouter.getI18nString('COMMON.RESTART'),\r\n          class: 'btn btn-info',\r\n          emit: 'callMethod',\r\n          payload: {\r\n            endpoint: 'music_service/jp_radio',\r\n            method: 'restartPlugin',\r\n            data: {}\r\n          }\r\n        },\r\n        {\r\n          name: this.commandRouter.getI18nString('COMMON.CANCEL'),\r\n          class: 'btn btn-info',\r\n          emit: 'closeModals',\r\n          payload: ''\r\n        }\r\n      ]\r\n    };\r\n    this.commandRouter.broadcastMessage('openModal', message);\r\n  }\r\n\r\n  saveServicePort(data: any): Promise<void> {\r\n    const newPort = parseInt(data['servicePort']);\r\n    if (!isNaN(newPort) && this.config.get('servicePort') !== newPort) {\r\n      this.config.set('servicePort', newPort);\r\n      this.showRestartModal();\r\n    }\r\n    return libQ.resolve();\r\n  }\r\n\r\n  saveRadikoAccount(data: any): Promise<void> {\r\n    const updated = ['radikoUser', 'radikoPass'].some(key => {\r\n      if (this.config.get(key) !== data[key]) {\r\n        this.config.set(key, data[key]);\r\n        return true;\r\n      }\r\n      return false;\r\n    });\r\n\r\n    if (updated) {\r\n      this.showRestartModal();\r\n    }\r\n\r\n    return libQ.resolve();\r\n  }\r\n\r\n  onVolumioStart(): Promise<void> {\r\n    const configFile = this.commandRouter.pluginManager.getConfigurationFile(this.context, 'config.json');\r\n    this.config = new VConf();\r\n    this.config.loadFile(configFile);\r\n    return libQ.resolve();\r\n  }\r\n\r\n  onStart(): Promise<void> {\r\n    const radikoUser = this.config.get('radikoUser');\r\n    const radikoPass = this.config.get('radikoPass');\r\n    const servicePort = this.config.get('servicePort') || 9000;\r\n\r\n    const account = (radikoUser && radikoPass) ? { mail: radikoUser, pass: radikoPass } : null;\r\n\r\n    this.appRadio = new JpRadio(servicePort, this.logger, account);\r\n    this.appRadio.start();\r\n    this.addToBrowseSources();\r\n\r\n    return libQ.resolve();\r\n  }\r\n\r\n  onStop(): Promise<void> {\r\n    this.appRadio.stop();\r\n    this.commandRouter.volumioRemoveToBrowseSources('RADIKO');\r\n    return libQ.resolve();\r\n  }\r\n\r\n  onRestart(): void {}\r\n\r\n  getUIConfig(): Promise<any> {\r\n    const defer = libQ.defer();\r\n    const lang_code = this.commandRouter.sharedVars.get('language_code');\r\n\r\n    this.commandRouter.i18nJson(\r\n      `${__dirname}/i18n/strings_${lang_code}.json`,\r\n      `${__dirname}/i18n/strings_en.json`,\r\n      `${__dirname}/UIConfig.json`\r\n    ).then((uiconf: any) => {\r\n      uiconf.sections[0].content[0].value = this.config.get('servicePort');\r\n      uiconf.sections[1].content[0].value = this.config.get('radikoUser');\r\n      uiconf.sections[1].content[1].value = this.config.get('radikoPass');\r\n      defer.resolve(uiconf);\r\n    }).fail(() => {\r\n      defer.reject(new Error());\r\n    });\r\n\r\n    return defer.promise;\r\n  }\r\n\r\n  getConfigurationFiles(): string[] {\r\n    return ['config.json'];\r\n  }\r\n\r\n  setUIConfig(data: any): void {}\r\n  getConf(varName: string): void {}\r\n  setConf(varName: string, varValue: any): void {}\r\n\r\n  addToBrowseSources(): void {\r\n    this.commandRouter.volumioAddToBrowseSources({\r\n      name: 'RADIKO',\r\n      uri: 'radiko',\r\n      plugin_type: 'music_service',\r\n      plugin_name: this.serviceName,\r\n      albumart: '/albumart?sourceicon=music_service/jp_radio/assets/images/app_radiko.svg'\r\n    });\r\n  }\r\n\r\n  handleBrowseUri(curUri: string): Promise<any> {\r\n    if (curUri === 'radiko') {\r\n      return libQ.resolve({\r\n        navigation: {\r\n          lists: [{\r\n            title: 'LIVE',\r\n            availableListViews: ['grid', 'list'],\r\n            items: this.appRadio.radioStations()\r\n          }]\r\n        }\r\n      });\r\n    }\r\n    return libQ.resolve();\r\n  }\r\n\r\n  clearAddPlayTrack(track: any): Promise<any> {\r\n    this.logger.info(`[${Date.now()}] JP_Radio::clearAddPlayTrack\\n${JSON.stringify(track)}`);\r\n    return libQ.resolve();\r\n  }\r\n\r\n  seek(timepos: number): Promise<any> {\r\n    this.logger.info(`[${Date.now()}] JP_Radio::seek to ${timepos}`);\r\n    return libQ.resolve();\r\n  }\r\n\r\n  stop(): void {\r\n    this.logger.info(`[${Date.now()}] JP_Radio::stop`);\r\n  }\r\n\r\n  pause(): void {\r\n    this.logger.info(`[${Date.now()}] JP_Radio::pause`);\r\n  }\r\n\r\n  getState(): void {\r\n    this.logger.info(`[${Date.now()}] JP_Radio::getState`);\r\n  }\r\n\r\n  parseState(sState: any): void {\r\n    this.logger.info(`[${Date.now()}] JP_Radio::parseState`);\r\n  }\r\n\r\n  pushState(state: any): any {\r\n    this.logger.info(`[${Date.now()}] JP_Radio::pushState`);\r\n    return this.commandRouter.servicePushState(state, this.serviceName);\r\n  }\r\n\r\n  explodeUri(uri: string): Promise<any> {\r\n    return libQ.resolve();\r\n  }\r\n\r\n  search(query: any): Promise<any> {\r\n    return libQ.resolve();\r\n  }\r\n\r\n  _searchArtists(results: any): void {}\r\n  _searchAlbums(results: any): void {}\r\n  _searchPlaylists(results: any): void {}\r\n  _searchTracks(results: any): void {}\r\n\r\n  goto(data: any): Promise<any> {\r\n    return libQ.resolve();\r\n  }\r\n}\r\n"]}